/*!
* Data Aquarium Framework - Offline Data Processor
* Copyright 2008-2017 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function i(n){var i=t._htmlDecoder;return i||(i=t._htmlDecoder=document.createElement("textarea")),i.innerHTML=n,i.value}var t=$app,n;n=t.odp={enabled:function(i){if(arguments.length&&(this._enabled=i),!this._checkedSettings&&typeof __settings!="undefined"){this._checkedSettings=!0;var r=__settings&&__settings.odp;r&&(r.enabled==!1&&(this._enabled=!1),r.pageSize&&(n._pageSize=r.pageSize))}return t.touch&&this._enabled!=!1},offline:function(){return!1},start:function(t){n.enabled(t);n.controllers={};n.functions={}},invoke:function(n,i){var a=this,l=n.get_servicePath(),h=i.url.substring(l.length+1),e=$.Deferred(),r,c=!0,u,o,f,s;return t.odp.enabled()&&(r=n.odp,r||h!="GetPage"||(u=n.tagged(/\odp\-enabled\-(\w+)\b/),u=u?u[1]:"auto",u!="none"&&(n._dataViewFieldParentId?(o=t.find(n._filterSource),o&&(r=o.odp)):(f=n.get_parentDataView(),f&&(n._filterSource&&(r=f.odp),r||(f.odp?r=f.odp:(r=new t.OfflineDataProcessor(n),r.enabled=u)))),!r&&n._isModal&&(s=$app.touch.dataView(),s&&(r=s.odp))),n.odp=r),r&&r.invoke({method:h,dataView:n,params:i,deferred:e})&&(c=!1)),c&&$.ajax(i).done(function(n){e.resolve(n)}).fail(function(n,t,i){e.reject(n,t,i)}),e.promise()},func:function(t){var i=n.functions[t];return i||(i=n.functions[t]=eval(t)),i}};t.OfflineDataProcessor=function(n){var t=this;t._dataView=n;t._state="inactive";t._data={};t._dataLoadMap={};t._dataLoadedKeys={};t._log=[];t._tracking={}};t.OfflineDataProcessor.prototype={is:function(n){var t=this;if(arguments.length){if(n.match(/^:/))return n==":dirty"?t._log.length>0:t._state==n.substring(1);t._state=n}else return t._state},root:function(n){return arguments.length==1?this._dataView==n:this._dataView},invoke:function(n){var t=this,f,i=n.dataView,e=i._controller,r=i._lastArgs,o=this._dataView==i,u=n.method;return o?u=="GetPage"&&i.get_lastCommandName()=="New"?t.is("active"):u=="Execute"&&r&&r.CommandName.match(/^(Insert|Update)$/)&&(t._log.splice(0,0,n.params.data),t.is("inactive")):u=="Execute"&&r&&r.CommandName.match(/^(Insert|Update|Delete)$/)&&(t.is("active"),t._log.push(n.params.data),t._tracking[i._controller]=!0),u.match(/^(GetPage|Execute|GetListOfValues)$/)&&t.tracking(i)&&($.when(t.getControllers([e])).done(function(){$.when(t.getData(e,i.get_externalFilter())).done(function(){t.execute(n)})}),f=!0),!!f},tracking:function(n){return!!this._tracking[n._controller]},getControllers:function(t){var i=[],r=$.Deferred(),u=n.controllers;return t.forEach(function(n){u[n]||i.push(n)}),i.length?$.ajax({url:__servicePath+"/getcontrollerlist",method:"POST",cache:!1,dataType:"text",data:JSON.stringify({controllers:i})}).done(function(n){var t=JSON.parse(JSON.parse(n).d);t.forEach(function(n){var t=n.dataController,i,r;u[t.name]=t;i=t._map={key:{},fields:{}};r=t.key=[];t.fields.forEach(function(n){i.fields[n.name]=n;n.isPrimaryKey&&(r.push(n),i.key[n.name]=n)})});r.resolve()}):r.resolve(),r.promise()},getData:function(i,r){function s(o){var h=n._pageSize||100;t.execute({controller:i,view:"offline",pageSize:h,pageIndex:o,requiresRowCount:o==0,externalFilter:r}).done(function(n){o==0&&(e=n.totalRowCount);u.addData(i,n[i]);e-=h;e<0?f.resolve():s(o+1)})}var u=this,f=$.Deferred(),e,o;return u._dataLoadMap[i]||(u._dataLoadMap[i]={}),o=r?JSON.stringify(r):"_all",u._dataLoadMap[i][o]?f.resolve():(u._dataLoadMap[i][o]=!0,u._dataLoadedKeys[i]={},s(0)),f.promise()},addData:function(t,i){var r=this,e=n.controllers[t],o=e.key,f=r._dataLoadedKeys[t],u=r._data[t];u||(u=r._data[t]=[]);i.forEach(function(n){var t=[];o.forEach(function(i){t.push(n[i.name])});t=t.join(",");f[t]||(f[t]=!0,u.push(n))})},execute:function(r){function y(n){r.deferred.resolve(JSON.stringify({d:n}))}var w=this,s=r.method,h=JSON.parse(i(r.params.data)),f=h.args,b=h.request,c=f?f.Values:null,l=n.controllers[h.controller],u=f?f.CommandName:null,k=l._map,e=[],a={},v=0,o,p;s=="Execute"?(o={Tag:null,Errors:[],Values:[],Canceled:!1,NavigateUrl:null,ClientScript:null,RowsAffected:0,Filter:null,SortExpression:null,RowNotFound:!1},u=="Update"||u=="Delete"?(c.forEach(function(n){k.key[n.Name]&&(e.length&&e.push("&&"),e.push("(this."+n.Name+"==params.p"+v+")"),a["p"+v++]=n.OldValue)}),w.find({controller:l.name,filter:e,params:a,limit:1,"delete":u=="Delete"}).done(function(n){var t=n[0];t&&u=="Update"&&c.forEach(function(n){n.Modified&&(t[n.Name]=n.NewValue)});o.RowsAffected=n.length;o.RowNotFound=n.length==0;y(o)})):u=="Insert"):s=="GetPage"?(p={},(b.Filter||[]).forEach(function(){}),y(p)):t.alert("Unknown method: "+s)},find:function(t){var o=this,s=$.Deferred(),a=t.controller,h=t.filter,v=t.params,c=t.sort,u=o._data[a],r=[],f=[],l,i,e;if(h){for(l=n.func("(function(params){return "+h+"})"),i=0;i,u.length;i++)if(e=u[i],l.call(e,v)&&(r.push(e),t.delete&&f.push(i),t.limit==r.length))break;for(i=f.length-1;i>=0;i--)u.splice(f[i],1)}else r=u.slice(0);return c&&r.sort(n.func(o._sortFunc(c))),s.resolve(r),s.promise()},_sortFunc:function(n){var t=["(function(a,b){"],u=/(\w+)(\s+(asc|desc))?/ig,i,r=!0;for(t.push("var result=0;");i=u.exec(n);)r?r=!1:t.push("if (result != 0) return result;"),t.push(String.format("if (a.{0} < b.{0}) result = -1; else if(a.{0} > b.{0}) result = 1;",i[1])),i[3]&&i[3].match(/^desc/i)&&t.push("if (result != 0) result *=-1;");return t.push("return result;"),t.push("})"),t.join("\n")},_filterFunc:function(){var n=["(function(a,b){"];return n.push("})"),n.join("\n")}};t.odp.start(!1)})();